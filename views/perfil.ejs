<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Footlaces | Perfil</title>
  <link rel="stylesheet" href="/stylesheets/perfil.css"> 
</head>
<body>

<%- include("header", { user: user }) %>

<% if (success) { %>
  <div class="alerta-exito"><%= success %></div>
<% } %>
<% if (error) { %>
  <div class="alerta-error"><%= error %></div>
<% } %>


<div class="perfil-container">
  <div class="sidebar">
    <ul>
      <li><strong>üìä Panel de control</strong></li>
      <li>üìç Direcciones (<%= numDirecciones || 0 %>)</li>
      <li><a href="/perfil/wishlist">üíñ Lista de deseos (<%= user.wishlist?.length || 0 %>)</a></li>
      <li><a href="/logout" class="logout">‚Ü© Cerrar sesi√≥n</a></li>
    </ul>
  </div>

  <div class="perfil-main">
    <div class="resumen-cajas">
      <div class="caja">
        <h4>Total Comprado</h4>
        <p><%= totalGastado?.toFixed(2) || "0.00" %>‚Ç¨</p>
      </div>
      <div class="caja">
        <h4>N√∫mero de Pedidos</h4>
        <p><%= numPedidos || 0 %></p>
      </div>
      <div class="caja">
        <h4>Direcciones</h4>
        <p><%= numDirecciones || 0 %></p>
      </div>
    </div>
    
    <h2>Detalles de la cuenta</h2>
    <table>
      <tr><td><strong>Nombre:</strong></td><td><%= user.nombre %></td></tr>
      <tr><td><strong>Correo electr√≥nico:</strong></td><td><%= user.email %></td></tr>
      <tr>
        <td><strong>Direcci√≥n 1:</strong></td>
        <td>
          <% if (user.direcciones?.[0]) { %>
            <%= user.direcciones[0].linea1 %>, <%= user.direcciones[0].ciudad %>, <%= user.direcciones[0].provincia %>, <%= user.direcciones[0].pais %>, <%= user.direcciones[0].codigoPostal %>
          <% } else { %> Sin registrar <% } %>
        </td>
      </tr>
      <tr>
        <td><strong>Direcci√≥n 2:</strong></td>
        <td>
          <% if (user.direcciones?.[1]) { %>
            <%= user.direcciones[1].linea1 %>, <%= user.direcciones[1].ciudad %>, <%= user.direcciones[1].provincia %>, <%= user.direcciones[1].pais %>, <%= user.direcciones[1].codigoPostal %>
          <% } else { %> Sin registrar <% } %>
        </td>
      </tr>
    </table>

    <h2>Historial de pedidos</h2>
<% if (!pedidos || pedidos.length === 0) { %>
  <p>‚úÖ <a href="/sneakers">Haz tu primer pedido</a> ‚Äî No has hecho ning√∫n pedido a√∫n.</p>
<% } else { %>
  <% pedidos.forEach(pedido => { %>
    <div class="pedido-box">
      <p><strong>Fecha:</strong> <%= pedido.fecha %></p>
      <p><strong>Estado:</strong> <%= pedido.estado %></p>
      <% if (pedido.estado === 'Devoluci√≥n denegada' && pedido.devolucion?.comentarioAdmin) { %>
        <p style="color: #dc3545;"><strong>Motivo del rechazo:</strong> <%= pedido.devolucion.comentarioAdmin %></p>
      <% } %>
      
      <p><strong>Total:</strong> <%= pedido.total?.toFixed(2) || "0.00" %>‚Ç¨</p>

      <div class="productos-pedido">
        <% pedido.productos.forEach(p => { %>
          <div class="producto-card">
            <img src="<%= p.producto.imagenes?.[0] || '/images/default.jpg' %>" alt="Imagen de <%= p.producto.nombre %>" width="100">
            <p><%= p.producto.nombre %></p>
            <p>Talla: <%= p.talla %></p>
            <p>Cantidad: <%= p.cantidad %></p>
            <p>Precio: <%= p.precio %>‚Ç¨</p>
          </div>
        <% }); %>
      </div>
      <br>
      
      <div class="acciones-pedido">
        <form action="/cancelar-pedido/<%= pedido._id %>" method="POST">
          <button type="submit" class="btn-cancelar">Cancelar pedido</button>
        </form>
      </div>
      <br>

      <% if (pedido.estado === 'Entregado') { %>
        <button class="btn-devolver" onclick="abrirModal('<%= pedido._id %>')">Solicitar devoluci√≥n</button>
      
        <!-- Modal -->
        <div id="modal-<%= pedido._id %>" class="modal-devolucion hidden">
          <div class="modal-contenido">
            <h3>Motivo de la devoluci√≥n</h3>
            <br>
            <form action="/devolver-pedido/<%= pedido._id %>" method="POST" onsubmit="return mostrarConfirmacion()">
              <label for="motivo">Selecciona un motivo:</label>
              <select name="motivo" required>
                <option value="Producto defectuoso">Producto defectuoso</option>
                <option value="No era lo que esperaba">No era lo que esperaba</option>
                <option value="Error en el pedido">Error en el pedido</option>
                <option value="Otro">Otro</option>
              </select>
              <br>
      
              <label for="comentario">Comentario adicional:</label>
              <br>
              <textarea name="comentario" rows="15" cols="50"></textarea>
              <br>
      
              <div class="modal-botones">
                <button type="submit" class="btn-enviar">Enviar</button>
                <button type="button" onclick="cerrarModal('<%= pedido._id %>')">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
      <% } %>
      
      
    </div>
  <% }) %>
<% } %>

  </div>
</div>
</body>
</html>
<script>
  function abrirModal(id) {
    document.getElementById('modal-' + id).classList.remove('hidden');
  }

  function cerrarModal(id) {
    document.getElementById('modal-' + id).classList.add('hidden');
  }
</script>

